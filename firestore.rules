rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Rules for journal entries
    match /journalEntries/{entryId} {
      allow read, update: if request.auth.token.email == 'ahsan.khan@mitwpu.edu.in';
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Rules for community posts
    match /posts/{postId} {
      // Anyone authenticated can read posts.
      allow read: if request.auth != null;
      
      // A user can create a post if they are authenticated and the authorId matches their UID.
      allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
      
      // A user can update their own post (e.g., comment count).
      allow update: if request.auth != null && resource.data.authorId == request.auth.uid;
      
      // A user can delete their own post OR if the user is the owner.
      allow delete: if request.auth != null && (resource.data.authorId == request.auth.uid || request.auth.token.email == 'ahsanimamkhan06@gmail.com');

      // Rules for comments within a post
      match /comments/{commentId} {
        // Anyone authenticated can read and create comments.
        allow read, create: if request.auth != null;
        
        // A user can delete their own comment OR if the user is the owner of the parent post.
        allow delete: if request.auth != null && (resource.data.authorId == request.auth.uid || get(/databases/$(database)/documents/posts/$(postId)).data.authorId == request.auth.uid);
      }
    }
  }
}
