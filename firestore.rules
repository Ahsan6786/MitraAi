rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper functions
    function isAuth() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuth() && request.auth.token.email == 'ahsan.khan@mitwpu.edu.in';
    }

    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    function isApprovedCounsellor() {
      return isAuth() && exists(/databases/$(database)/documents/counsellors/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/counsellors/$(request.auth.uid)).data.status == 'approved';
    }

    // Counsellors Collection
    match /counsellors/{counsellorId} {
      // Anyone authenticated can create a request to become a counsellor
      allow create: if isAuth();
      
      // Admin can read, update (approve/reject), and delete any counsellor document
      // An approved counsellor can read their own document
      allow read, update, delete: if isAdmin() || (isApprovedCounsellor() && request.auth.uid == counsellorId);
      
      // Any authenticated user can list/get approved counsellors for booking
      allow list, get: if isAuth() && (resource == null || resource.data.status == 'approved');
    }

    // Journal Entries Collection
    match /journalEntries/{entryId} {
      allow read, update, delete: if isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId);
      
      // Admin can read entries for review
      allow get, list: if isAdmin();
    }
    
    // Questionnaires Collection
    match /questionnaires/{submissionId} {
      allow read, update, delete: if isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId);
      
      // Admin can read submissions for review
      allow get, list: if isAdmin();
    }
    
    // Bookings Collection
    match /bookings/{bookingId} {
      // User can create, read, and cancel (delete) their own bookings
      allow create: if isOwner(request.resource.data.student_id);
      allow read, delete: if isOwner(resource.data.student_id);
      
      // Approved counsellors can read and update bookings assigned to them
      allow read, update: if isApprovedCounsellor() && request.auth.uid == resource.data.counsellor_id;
    }

    // Community Posts
    match /posts/{postId} {
      allow read: if isAuth();
      allow create: if isOwner(request.resource.data.authorId);
      allow delete: if isOwner(resource.data.authorId) || isAdmin();
      
      // Allow anyone authenticated to update only the commentCount field
      allow update: if isAuth() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['commentCount']);
    }

    // Comments subcollection
    match /posts/{postId}/comments/{commentId} {
      allow read: if isAuth();
      allow create: if isOwner(request.resource.data.authorId);
      allow delete: if isOwner(resource.data.authorId) || isAdmin();
      allow update: if isAdmin(); // For hiding/unhiding comments
    }
  }
}
