
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Counsellors can be created by any user, but only updated/read by the admin.
    match /counsellors/{counsellorId} {
      allow create: if request.auth != null && request.resource.data.status == 'pending' && request.auth.uid == counsellorId;
      allow read, list: if request.auth.token.email == 'ahsan.khan@mitwpu.edu.in';
      allow update: if request.auth.token.email == 'ahsan.khan@mitwpu.edu.in'
                      && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])
                      && (request.resource.data.status == 'approved' || request.resource.data.status == 'rejected');
    }
    
    // Users can manage their own journal entries
    match /journalEntries/{entryId} {
        allow read, write, delete: if request.auth.uid == resource.data.userId;
        allow create: if request.auth.uid == request.resource.data.userId;
    }

    // Users can manage their own questionnaire submissions
    match /questionnaires/{submissionId} {
        allow read, write, delete: if request.auth.uid == resource.data.userId;
        allow create: if request.auth.uid == request.resource.data.userId;
    }

    // Community Posts rules
    match /posts/{postId} {
      // Anyone logged in can read posts
      allow read: if request.auth != null;
      // Users can create posts if they are logged in
      allow create: if request.auth.uid == request.resource.data.authorId;
      // Users can delete their own posts, or the admin can delete any post
      allow delete: if request.auth.uid == resource.data.authorId || request.auth.token.email == 'ahsanimamkhan06@gmail.com';
      // Users can update their own comment counts (e.g. via transactions)
      allow update: if request.auth.uid == resource.data.authorId;

        // Comments subcollection
        match /comments/{commentId} {
            // Anyone logged in can read comments
            allow read: if request.auth != null;
            // Anyone logged in can create a comment
            allow create: if request.auth.uid == request.resource.data.authorId;
            // Users can update their own comments (e.g. hiding) or admin can
            allow update: if request.auth.uid == resource.data.authorId || request.auth.token.email == 'ahsanimamkhan06@gmail.com';
            // Users can delete their own comments or admin can
            allow delete: if request.auth.uid == resource.data.authorId || request.auth.token.email == 'ahsanimamkhan06@gmail.com';
        }
    }
  }
}
